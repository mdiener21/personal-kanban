import{m as V,r as j,f as H,n as P,l as U,a as G}from"./storage-CHWOfylf.js";import{u as Z,i as $,a as _,b as q,c as J,d as K,e as Q,f as X,g as ee,h as te,j as ne,k as oe,l as ae}from"./vendor-echarts-D4nkTg7A.js";import"./vendor-Dbh21kxK.js";import"./vendor-zrender-CjwHy-WR.js";Z([_,q,J,K,Q,X,ee,te,ne,oe,ae]);function se(e){const t=(e||"").toString().trim();return t&&t.length>=10?t.slice(0,10):""}function x(e){const t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${l}`}function T(e,t){const r=[],l=new Date(e.getFullYear(),e.getMonth(),e.getDate()),c=new Date(t.getFullYear(),t.getMonth(),t.getDate());for(;l<=c;)r.push(new Date(l)),l.setDate(l.getDate()+1);return r}function w(e){const t=(e||"").toString().trim();if(!t)return null;const r=new Date(t);return Number.isNaN(r.getTime())?null:r}function S(e){const t=new Date(e.getFullYear(),e.getMonth(),e.getDate()),l=(t.getDay()+6)%7;return t.setDate(t.getDate()-l),t}function B(e,t){const r=new Date(e);return r.setDate(r.getDate()+t),r}function re(e){const t=B(e,6);return`${x(e)}…${x(t)}`}function le(e,t){const r=[],l=S(e),c=S(t),n=new Date(l);for(;n<=c;)r.push(new Date(n)),n.setDate(n.getDate()+7);return r}function ie(e,t,r){const l=new Map;for(const o of e){const a=se(o?.changeDate);a&&l.set(a,(l.get(a)||0)+1)}const n=T(t,r).map(o=>{const a=x(o);return[a,l.get(a)||0]}),s=n.reduce((o,[,a])=>Math.max(o,Number(a)||0),0);return{data:n,max:s}}function ce({rangeStart:e,rangeEnd:t,data:r,maxValue:l,boardName:c}){const n=Math.max(1,l||0);return{title:{top:20,left:"center",text:`Daily updates — ${c}`},tooltip:{formatter:s=>{const o=s?.value?.[0]||"",a=s?.value?.[1]??0;return`${o}: ${a} update${a===1?"":"s"}`}},visualMap:{min:0,max:n,type:"piecewise",orient:"horizontal",left:"center",top:55},calendar:{top:110,left:30,right:30,cellSize:["auto",14],range:[x(e),x(t)],itemStyle:{borderWidth:.5},yearLabel:{show:!1}},series:{type:"heatmap",coordinateSystem:"calendar",data:r}}}function de(e,t){const r=Math.max(1,Number(t)||1),l=[];for(let c=0;c<e.length;c++){const n=Math.max(0,c-r+1),s=e.slice(n,c+1).filter(a=>Number.isFinite(a));if(s.length===0){l.push(null);continue}const o=s.reduce((a,m)=>a+m,0)/s.length;l.push(Number(o.toFixed(2)))}return l}function ue(e,t,r){const l=new Map;for(const d of e){const u=w(d?.creationDate),i=w(d?.doneDate);if(!u||!i||i<t||i>r)continue;const p=S(i),b=x(p),y=(i.getTime()-u.getTime())/(1440*60*1e3);if(!Number.isFinite(y)||y<0)continue;const f=l.get(b)||{count:0,leadSumDays:0};f.count+=1,f.leadSumDays+=y,l.set(b,f)}const c=le(t,r),n=c.map(re),s=c.map(d=>x(d)),o=s.map(d=>l.get(d)?.count||0),a=s.map(d=>{const u=l.get(d);return!u||u.count===0?null:Number((u.leadSumDays/u.count).toFixed(2))}),m=o.reduce((d,u)=>d+u,0),g=s.map(d=>{const u=l.get(d);return!u||u.count===0?null:u.leadSumDays/u.count}).filter(d=>Number.isFinite(d)),h=g.length?g.reduce((d,u)=>d+u,0)/g.length:null;return{labels:n,completedCounts:o,avgLeadDays:a,trendLeadDays:de(a.map(d=>d??NaN),4),totalCompleted:m,avgLeadOverall:h}}function me({labels:e,avgLeadDays:t,trendLeadDays:r,completedCounts:l}){const c=Math.max(1,...t.map(n=>Number.isFinite(n)?n:0));return{tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:n=>{const s=Array.isArray(n)?n:[],o=s[0]?.axisValueLabel||"",a=new Map(s.map(p=>[p.seriesName,p.value])),m=a.get("Avg lead time (days)"),g=a.get("Trend (4-week MA)"),h=a.get("Completed"),d=Number.isFinite(m)?`${m}d`:"—",u=Number.isFinite(g)?`${g}d`:"—",i=Number.isFinite(h)?`${h}`:"0";return`${o}<br/>Completed: ${i}<br/>Avg lead time: ${d}<br/>Trend: ${u}`}},legend:{top:8},grid:{left:40,right:40,top:50,bottom:40},xAxis:{type:"category",data:e,axisLabel:{interval:1,rotate:20}},yAxis:[{type:"value",name:"Days",min:0,max:Math.ceil(c)},{type:"value",name:"Completed",min:0,axisLabel:{formatter:"{value}"}}],series:[{name:"Avg lead time (days)",type:"bar",data:t.map(n=>n??0),itemStyle:{color:"#3b82f6"},yAxisIndex:0},{name:"Trend (4-week MA)",type:"line",data:r.map(n=>n??null),smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:3,color:"#16a34a"},itemStyle:{color:"#16a34a"},yAxisIndex:0},{name:"Completed",type:"line",data:l,smooth:!0,symbol:"none",lineStyle:{width:2,type:"dashed",color:"#6b7280"},yAxisIndex:1}]}}function pe({labels:e,completedCounts:t}){return{grid:{left:8,right:8,top:8,bottom:8},xAxis:{type:"category",data:e,show:!1},yAxis:{type:"value",show:!1,min:0},tooltip:{trigger:"axis",axisPointer:{type:"line"},formatter:r=>{const l=Array.isArray(r)?r[0]:r,c=l?.axisValueLabel||"",n=l?.value??0;return`${c}<br/>Completed: ${n}`}},series:[{type:"line",data:t,smooth:!0,symbol:"none",lineStyle:{width:2,color:"#3b82f6"},areaStyle:{color:"rgba(59, 130, 246, 0.18)"}}]}}function O(e){return typeof e=="string"&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(e.trim())}function ge(e,t){const r=Math.max(0,Math.min(1,Number(t)));if(!O(e))return`rgba(59,130,246,${r})`;const l=e.trim().slice(1),c=l.length===3?l.split("").map(a=>a+a).join(""):l,n=Number.parseInt(c.slice(0,2),16),s=Number.parseInt(c.slice(2,4),16),o=Number.parseInt(c.slice(4,6),16);return`rgba(${n},${s},${o},${r})`}function ye(e){const t=Array.isArray(e)?e.slice():[],r=t.find(s=>s?.id==="done")||null,c=t.filter(s=>s?.id&&s.id!=="done").map((s,o)=>({c:s,idx:o}));c.sort((s,o)=>{const a=Number.isFinite(s.c?.order)?s.c.order:null,m=Number.isFinite(o.c?.order)?o.c.order:null;return a!=null&&m!=null&&a!==m?a-m:a!=null&&m==null?-1:a==null&&m!=null?1:s.idx-o.idx});const n=c.map(s=>s.c);return r&&n.push(r),n}function fe(e){const t=e?.columnHistory,l=(Array.isArray(t)?t:[]).map(s=>{const o=typeof s?.column=="string"?s.column.trim():"",a=w(s?.at);return!o||!a?null:{column:o,at:a}}).filter(Boolean).sort((s,o)=>s.at.getTime()-o.at.getTime());if(l.length>0)return l;const c=w(e?.creationDate)||w(e?.changeDate)||w(e?.doneDate),n=typeof e?.column=="string"?e.column.trim():"";return!c||!n?[]:[{column:n,at:c}]}function he({tasks:e,columns:t,rangeStart:r,rangeEnd:l,includeDone:c}){const n=T(r,l),s=n.map(i=>new Date(i.getFullYear(),i.getMonth(),i.getDate(),23,59,59,999)),o=n.map(i=>x(i)),a=new Map,m=i=>(a.has(i)||a.set(i,new Array(o.length).fill(0)),a.get(i));for(const i of e||[]){const p=fe(i);if(!p.length)continue;let b=null,y=-1;for(let f=0;f<s.length;f++){const C=s[f];for(;y+1<p.length&&p[y+1].at<=C;)y+=1,b=p[y].column;if(!b||!c&&b==="done")continue;const k=m(b);k[f]+=1}}const g=ye(t),h=new Map(g.map(i=>[i.id,i])),d=g.map(i=>i.id);for(const i of a.keys())d.includes(i)||d.push(i);const u=d.filter(i=>c||i!=="done").map(i=>{const p=h.get(i),b=typeof p?.name=="string"&&p.name.trim()?p.name.trim():i==="done"?"Done":i,y=O(p?.color)?p.color.trim():"#3b82f6",f=a.get(i)||new Array(o.length).fill(0);return{id:i,name:b,color:y,data:f}});return{labels:o,seriesDefs:u}}function be({labels:e,seriesDefs:t,boardName:r}){const l=Array.isArray(t)?t.slice().reverse():[],c=t.length?Math.max(1,...e.map((n,s)=>t.reduce((o,a)=>o+(a.data[s]||0),0))):1;return{title:{top:12,left:"center",text:`Cumulative flow — ${r}`},tooltip:{trigger:"axis",axisPointer:{type:"line"},formatter:n=>{const s=Array.isArray(n)?n:[],a=[`${s[0]?.axisValueLabel||""}`];let m=0;for(const g of s){const h=Number(g?.value)||0;m+=h,a.push(`${g.marker||""}${g.seriesName}: ${h}`)}return a.push(`<span style="opacity:.7">Total: ${m}</span>`),a.join("<br/>")}},legend:{top:40,type:"scroll"},grid:{left:40,right:20,top:80,bottom:45},xAxis:{type:"category",data:e,boundaryGap:!1,axisLabel:{hideOverlap:!0}},yAxis:{type:"value",name:"Tasks",min:0,max:Math.ceil(c)},dataZoom:[{type:"inside",xAxisIndex:0,filterMode:"none"}],series:l.map(n=>({name:n.name,type:"line",stack:"total",symbol:"none",data:n.data,lineStyle:{width:1.5,color:n.color},itemStyle:{color:n.color},areaStyle:{color:ge(n.color,.28)},emphasis:{focus:"series"}}))}}function De(){V(),j();const e=H();P();const t=document.getElementById("reports-board-badge");t&&(t.textContent=e.slice(0,2).toUpperCase());const r=U(),l=G(),c=new Date,n=new Date(c.getFullYear(),c.getMonth(),c.getDate(),23,59,59,999),s=B(n,-77),o=ue(r,s,n),a=o.completedCounts[o.completedCounts.length-1]||0,m=o.completedCounts[o.completedCounts.length-2]||0,g=Number.isFinite(o.avgLeadOverall)?`${o.avgLeadOverall.toFixed(1)}d`:"–",h=document.getElementById("reports-completed-this-week"),d=document.getElementById("reports-completed-last-week"),u=document.getElementById("reports-avg-leadtime-12w");h&&(h.textContent=String(a)),d&&(d.textContent=String(m)),u&&(u.textContent=g);const i=document.getElementById("reports-leadtime-badge");i&&(i.textContent=String(o.totalCompleted));const p=document.getElementById("reports-completed-spark");if(p){const D=$(p);D.setOption(pe({labels:o.labels,completedCounts:o.completedCounts})),window.addEventListener("resize",()=>D.resize())}const b=document.getElementById("reports-leadtime-chart");if(b){const D=$(b);D.setOption(me({labels:o.labels,avgLeadDays:o.avgLeadDays,trendLeadDays:o.trendLeadDays,completedCounts:o.completedCounts})),window.addEventListener("resize",()=>D.resize())}const y=new Date,f=new Date;f.setDate(y.getDate()-364);const{data:C,max:k}=ie(r,f,y),N=document.getElementById("reports-chart");if(N){const D=$(N),v=ce({rangeStart:f,rangeEnd:y,data:C,maxValue:k,boardName:e});D.setOption(v),window.addEventListener("resize",()=>D.resize())}const I=document.getElementById("reports-cfd-chart"),L=document.getElementById("reports-cfd-range"),A=document.getElementById("reports-cfd-include-done");if(I){const D=$(I),v=()=>{const M=Number.parseInt((L?.value??"90").toString(),10),z=Number.isFinite(M)?Math.min(365,Math.max(7,M)):90,W=A?A.checked===!0:!0,E=new Date,F=new Date;F.setDate(E.getDate()-(z-1));const{labels:Y,seriesDefs:R}=he({tasks:r,columns:l,rangeStart:F,rangeEnd:E,includeDone:W});D.setOption(be({labels:Y,seriesDefs:R,boardName:e}),!0)};v(),L?.addEventListener("change",v),A?.addEventListener("change",v),window.addEventListener("resize",()=>D.resize())}}De();
