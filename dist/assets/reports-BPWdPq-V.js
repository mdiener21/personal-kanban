import{q as _,m as J,r as Q,f as X,n as ee,l as te,a as oe}from"./theme-LZpruhkc.js";import{u as ne,i as v,a as ae,b as re,c as se,d as le,e as ie,f as ce,g as ue,h as de,j as me,k as ye,l as pe}from"./vendor-echarts-uPYFcEXt.js";import"./vendor-pJTqpwCg.js";import"./vendor-zrender-uIsHjr8e.js";ne([ae,re,se,le,ie,ce,ue,de,me,ye,pe]);function L(e,o){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()||o}function N(){return{text:L("--text","#111827"),muted:L("--text-muted","#6b7280"),border:L("--border","#d1d5db"),borderSubtle:L("--border-subtle","#e5e7eb"),surface:L("--surface","#ffffff")}}function B(e){const o=(e||"").toString().trim();return o&&o.length>=10?o.slice(0,10):""}function k(e){const o=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${o}-${s}-${a}`}function F(e){return`${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function j(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}function w(e){const o=(e||"").toString().trim();if(!o)return null;const s=new Date(o);return Number.isNaN(s.getTime())?null:s}function T(e,o){const s=new Date(e);return s.setDate(s.getDate()+o),s}function A(e){const o=new Date(e.getFullYear(),e.getMonth(),e.getDate()),s=(o.getDay()+6)%7;return o.setDate(o.getDate()-s),o}function R(e){return new Date(e.getFullYear(),e.getMonth(),1)}function E(e,o){const s=[],a=new Date(e.getFullYear(),e.getMonth(),e.getDate()),r=new Date(o.getFullYear(),o.getMonth(),o.getDate());for(;a<=r;)s.push(new Date(a)),a.setDate(a.getDate()+1);return s}function ge(e,o){const s=[],a=new Date(A(e)),r=A(o);for(;a<=r;)s.push(new Date(a)),a.setDate(a.getDate()+7);return s}function fe(e,o){const s=[],a=R(e),r=R(o);for(;a<=r;)s.push(new Date(a)),a.setMonth(a.getMonth()+1);return s}function G(e,o){return o==="daily"?k(e):o==="monthly"?j(e):k(A(e))}function O(e,o,s){if(s==="daily"){const r=E(e,o);return{keys:r.map(k),labels:r.map(F)}}if(s==="monthly"){const n=fe(e,o).map(j);return{keys:n,labels:n}}const a=ge(e,o);return{keys:a.map(k),labels:a.map(r=>`${F(r)} → ${F(T(r,6))}`)}}function P({labels:e,seriesList:o,granularity:s,legend:a}){const r=N(),t=s!=="daily"?{show:!0,position:"top",fontSize:10,color:r.text,formatter:l=>l.value>0?String(l.value):""}:{show:!1};return{backgroundColor:"transparent",grid:{left:40,right:40,top:a?30:8,bottom:32},legend:a?{top:0,textStyle:{color:r.muted,fontSize:10}}:void 0,xAxis:{type:"category",data:e,axisLabel:{show:!0,fontSize:9,color:r.muted,rotate:30,hideOverlap:!0},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",name:"Tasks",min:0,nameTextStyle:{color:r.muted},axisLabel:{color:r.muted},axisLine:{lineStyle:{color:r.borderSubtle}},axisTick:{lineStyle:{color:r.borderSubtle}},splitLine:{lineStyle:{color:r.borderSubtle}}},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},backgroundColor:r.surface,borderColor:r.border,textStyle:{color:r.text}},dataZoom:s==="daily"?[{type:"inside",xAxisIndex:0,filterMode:"none"}]:[],series:o.map(l=>({name:l.name,type:"bar",data:l.data,itemStyle:{color:l.color,borderRadius:[2,2,0,0]},label:t}))}}function be(e,o,s){const a=new Map;for(const l of e||[]){const i=B(l?.changeDate);i&&a.set(i,(a.get(i)||0)+1)}const n=E(o,s).map(l=>{const i=k(l);return[i,a.get(i)||0]}),t=n.reduce((l,[,i])=>Math.max(l,Number(i)||0),0);return{data:n,max:t}}function he({rangeStart:e,rangeEnd:o,data:s,maxValue:a,boardName:r}){const n=Math.max(1,a||0),t=N();return{backgroundColor:"transparent",textStyle:{color:t.text},title:{top:20,left:"center",text:`Daily updates — ${r}`,textStyle:{color:t.text}},tooltip:{backgroundColor:t.surface,borderColor:t.border,textStyle:{color:t.text},formatter:l=>{const i=l?.value?.[0]||"",d=l?.value?.[1]??0;return`${i}: ${d} update${d===1?"":"s"}`}},visualMap:{min:0,max:n,type:"piecewise",orient:"horizontal",left:"center",top:55,textStyle:{color:t.muted}},calendar:{top:110,left:30,right:30,cellSize:["auto",14],range:[k(e),k(o)],itemStyle:{borderWidth:.5,borderColor:t.borderSubtle},dayLabel:{color:t.muted},monthLabel:{color:t.text},yearLabel:{show:!1}},series:{type:"heatmap",coordinateSystem:"calendar",data:s}}}function xe(e,o,s,a){const r=new Map;for(const i of e||[]){const d=w(i?.doneDate);if(!d||d<o||d>s)continue;const g=G(d,a);r.set(g,(r.get(g)||0)+1)}const{keys:n,labels:t}=O(o,s,a),l=n.map(i=>r.get(i)||0);return{labels:t,completedCounts:l}}function V(e,o,s,a){const r=new Map,n=new Map;for(const u of e||[]){const m=B(u?.creationDate),y=B(u?.doneDate);if(!m||!y)continue;const c=w(y);if(!c||c<o||c>s)continue;const p=G(c,a);m===y?r.set(p,(r.get(p)||0)+1):n.set(p,(n.get(p)||0)+1)}const{keys:t,labels:l}=O(o,s,a),i=t.map(u=>r.get(u)||0),d=t.map(u=>n.get(u)||0),g=i.reduce((u,m)=>u+m,0);return{labels:l,sameDayCounts:i,plannedCounts:d,total:g}}function Se(e,o){const s=Math.max(1,Number(o)||1),a=[];for(let r=0;r<e.length;r++){const n=Math.max(0,r-s+1),t=e.slice(n,r+1).filter(i=>Number.isFinite(i));if(t.length===0){a.push(null);continue}const l=t.reduce((i,d)=>i+d,0)/t.length;a.push(Number(l.toFixed(2)))}return a}function De(e,o,s){const a=new Map;for(const u of e){const m=w(u?.creationDate),y=w(u?.doneDate);if(!m||!y||y<o||y>s)continue;const c=k(A(y)),p=(y.getTime()-m.getTime())/(1440*60*1e3);if(!Number.isFinite(p)||p<0)continue;const b=a.get(c)||{count:0,leadSumDays:0};b.count+=1,b.leadSumDays+=p,a.set(c,b)}const{keys:r,labels:n}=O(o,s,"weekly"),t=r.map(u=>a.get(u)?.count||0),l=r.map(u=>{const m=a.get(u);return!m||m.count===0?null:Number((m.leadSumDays/m.count).toFixed(2))}),i=t.reduce((u,m)=>u+m,0),d=l.filter(u=>Number.isFinite(u)),g=d.length?d.reduce((u,m)=>u+m,0)/d.length:null;return{labels:n,completedCounts:t,avgLeadDays:l,trendLeadDays:Se(l.map(u=>u??NaN),4),totalCompleted:i,avgLeadOverall:g}}function ke({labels:e,avgLeadDays:o,trendLeadDays:s,completedCounts:a}){const r=Math.max(1,...o.map(t=>Number.isFinite(t)?t:0)),n=N();return{backgroundColor:"transparent",textStyle:{color:n.text},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},backgroundColor:n.surface,borderColor:n.border,textStyle:{color:n.text},formatter:t=>{const l=Array.isArray(t)?t:[],i=l[0]?.axisValueLabel||"",d=new Map(l.map(b=>[b.seriesName,b.value])),g=d.get("Avg lead time (days)"),u=d.get("Trend (4-week MA)"),m=d.get("Completed"),y=Number.isFinite(g)?`${g}d`:"—",c=Number.isFinite(u)?`${u}d`:"—",p=Number.isFinite(m)?`${m}`:"0";return`${i}<br/>Completed: ${p}<br/>Avg lead time: ${y}<br/>Trend: ${c}`}},legend:{top:8,textStyle:{color:n.muted}},grid:{left:40,right:40,top:50,bottom:40},xAxis:{type:"category",data:e,axisLabel:{interval:1,rotate:20,color:n.muted},axisLine:{lineStyle:{color:n.borderSubtle}},axisTick:{lineStyle:{color:n.borderSubtle}}},yAxis:[{type:"value",name:"Days",min:0,max:Math.ceil(r),nameTextStyle:{color:n.muted},axisLabel:{color:n.muted},axisLine:{lineStyle:{color:n.borderSubtle}},axisTick:{lineStyle:{color:n.borderSubtle}},splitLine:{lineStyle:{color:n.borderSubtle}}},{type:"value",name:"Completed",min:0,nameTextStyle:{color:n.muted},axisLabel:{formatter:"{value}",color:n.muted},axisLine:{lineStyle:{color:n.borderSubtle}},axisTick:{lineStyle:{color:n.borderSubtle}},splitLine:{show:!1}}],series:[{name:"Completed",type:"bar",data:a,itemStyle:{color:"#3b82f6"},yAxisIndex:1},{name:"Avg lead time (days)",type:"line",data:o.map(t=>t??null),smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:3,color:"#16a34a"},itemStyle:{color:"#16a34a"},yAxisIndex:0},{name:"Trend (4-week MA)",type:"line",data:s.map(t=>t??null),smooth:!0,symbol:"none",lineStyle:{width:2,type:"dashed",color:"#6b7280"},itemStyle:{color:"#6b7280"},yAxisIndex:0}]}}function H(e){return typeof e=="string"&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(e.trim())}function Ce(e,o){const s=Math.max(0,Math.min(1,Number(o)));if(!H(e))return`rgba(59,130,246,${s})`;const a=e.trim().slice(1),r=a.length===3?a.split("").map(i=>i+i).join(""):a,n=Number.parseInt(r.slice(0,2),16),t=Number.parseInt(r.slice(2,4),16),l=Number.parseInt(r.slice(4,6),16);return`rgba(${n},${t},${l},${s})`}function we(e){const o=Array.isArray(e)?e.slice():[],s=o.find(t=>t?.id==="done")||null,r=o.filter(t=>t?.id&&t.id!=="done").map((t,l)=>({c:t,idx:l}));r.sort((t,l)=>{const i=Number.isFinite(t.c?.order)?t.c.order:null,d=Number.isFinite(l.c?.order)?l.c.order:null;return i!=null&&d!=null&&i!==d?i-d:i!=null&&d==null?-1:i==null&&d!=null?1:t.idx-l.idx});const n=r.map(t=>t.c);return s&&n.push(s),n}function ve(e){const o=e?.columnHistory,a=(Array.isArray(o)?o:[]).map(t=>{const l=typeof t?.column=="string"?t.column.trim():"",i=w(t?.at);return!l||!i?null:{column:l,at:i}}).filter(Boolean).sort((t,l)=>t.at.getTime()-l.at.getTime());if(a.length>0)return a;const r=w(e?.creationDate)||w(e?.changeDate)||w(e?.doneDate),n=typeof e?.column=="string"?e.column.trim():"";return!r||!n?[]:[{column:n,at:r}]}function Le({tasks:e,columns:o,rangeStart:s,rangeEnd:a,includeDone:r}){const n=E(s,a),t=n.map(c=>new Date(c.getFullYear(),c.getMonth(),c.getDate(),23,59,59,999)),l=n.map(c=>k(c)),i=new Map,d=c=>(i.has(c)||i.set(c,new Array(l.length).fill(0)),i.get(c));for(const c of e||[]){const p=ve(c);if(!p.length)continue;let b=null,h=-1;for(let D=0;D<t.length;D++){const $=t[D];for(;h+1<p.length&&p[h+1].at<=$;)h+=1,b=p[h].column;if(!b||!r&&b==="done")continue;const M=d(b);M[D]+=1}}const g=we(o),u=new Map(g.map(c=>[c.id,c])),m=g.map(c=>c.id);for(const c of i.keys())m.includes(c)||m.push(c);const y=m.filter(c=>r||c!=="done").map(c=>{const p=u.get(c),b=typeof p?.name=="string"&&p.name.trim()?p.name.trim():c==="done"?"Done":c,h=H(p?.color)?p.color.trim():"#3b82f6",D=i.get(c)||new Array(l.length).fill(0);return{id:c,name:b,color:h,data:D}});return{labels:l,seriesDefs:y}}function $e({labels:e,seriesDefs:o,boardName:s}){const a=Array.isArray(o)?o.slice().reverse():[],r=o.length?Math.max(1,...e.map((t,l)=>o.reduce((i,d)=>i+(d.data[l]||0),0))):1,n=N();return{backgroundColor:"transparent",textStyle:{color:n.text},title:{top:12,left:"center",text:`Cumulative flow — ${s}`,textStyle:{color:n.text}},tooltip:{trigger:"axis",axisPointer:{type:"line"},backgroundColor:n.surface,borderColor:n.border,textStyle:{color:n.text},formatter:t=>{const l=Array.isArray(t)?t:[],d=[`${l[0]?.axisValueLabel||""}`];let g=0;for(const u of l){const m=Number(u?.value)||0;g+=m,d.push(`${u.marker||""}${u.seriesName}: ${m}`)}return d.push(`<span style="opacity:.7">Total: ${g}</span>`),d.join("<br/>")}},legend:{top:40,type:"scroll",textStyle:{color:n.muted}},grid:{left:40,right:20,top:80,bottom:45},xAxis:{type:"category",data:e,boundaryGap:!1,axisLabel:{hideOverlap:!0,color:n.muted},axisLine:{lineStyle:{color:n.borderSubtle}},axisTick:{lineStyle:{color:n.borderSubtle}}},yAxis:{type:"value",name:"Tasks",min:0,max:Math.ceil(r),nameTextStyle:{color:n.muted},axisLabel:{color:n.muted},axisLine:{lineStyle:{color:n.borderSubtle}},axisTick:{lineStyle:{color:n.borderSubtle}},splitLine:{lineStyle:{color:n.borderSubtle}}},dataZoom:[{type:"inside",xAxisIndex:0,filterMode:"none"}],series:a.map(t=>({name:t.name,type:"line",stack:"total",symbol:"none",data:t.data,lineStyle:{width:1.5,color:t.color},itemStyle:{color:t.color},areaStyle:{color:Ce(t.color,.28)},emphasis:{focus:"series"}}))}}function Me(){_(),J(),Q();const e=X();ee();const o=e,s=document.getElementById("reports-board-badge");s&&(s.textContent=e.slice(0,2).toUpperCase());const a=te(),r=oe(),n=[],t=new Date,l=T(t,-364),i=be(a,l,t),d=document.getElementById("reports-chart");if(d){const f=v(d);f.setOption(he({rangeStart:l,rangeEnd:t,data:i.data,maxValue:i.max,boardName:o})),n.push(f)}const g=new Date,u=new Date(g.getFullYear(),g.getMonth(),g.getDate(),23,59,59,999),m=T(u,-77),y=De(a,m,u),c=(f,x)=>{const S=document.getElementById(f);S&&(S.textContent=x)};c("reports-completed-this-week",String(y.completedCounts[y.completedCounts.length-1]||0)),c("reports-completed-last-week",String(y.completedCounts[y.completedCounts.length-2]||0)),c("reports-avg-leadtime-12w",Number.isFinite(y.avgLeadOverall)?`${y.avgLeadOverall.toFixed(1)}d`:"–"),c("reports-completion-badge",String(y.totalCompleted)),c("reports-leadtime-badge",String(y.totalCompleted));const p=document.getElementById("reports-completed-spark"),b=document.getElementById("reports-completion-granularity");if(p){const f=v(p);n.push(f);const x=()=>{const S=b?.value||"weekly",C=xe(a,m,u,S);f.setOption(P({labels:C.labels,seriesList:[{data:C.completedCounts,color:"#3b82f6"}],granularity:S,legend:!1}),!0)};x(),b?.addEventListener("change",x)}const h=V(a,m,u,"weekly");c("reports-sameday-this-week",String(h.sameDayCounts[h.sameDayCounts.length-1]||0)),c("reports-sameday-last-week",String(h.sameDayCounts[h.sameDayCounts.length-2]||0)),c("reports-sameday-avg",h.sameDayCounts.length?(h.total/h.sameDayCounts.length).toFixed(1):"–"),c("reports-sameday-badge",String(h.total));const D=document.getElementById("reports-sameday-spark"),$=document.getElementById("reports-sameday-granularity");if(D){const f=v(D);n.push(f);const x=()=>{const S=$?.value||"weekly",C=V(a,m,u,S);f.setOption(P({labels:C.labels,seriesList:[{name:"Same-day",data:C.sameDayCounts,color:"#f59e0b"},{name:"Planned",data:C.plannedCounts,color:"#3b82f6"}],granularity:S,legend:!0}),!0)};x(),$?.addEventListener("change",x)}const M=document.getElementById("reports-leadtime-chart");if(M){const f=v(M);f.setOption(ke({labels:y.labels,avgLeadDays:y.avgLeadDays,trendLeadDays:y.trendLeadDays,completedCounts:y.completedCounts})),n.push(f)}const z=document.getElementById("reports-cfd-chart"),Y=document.getElementById("reports-cfd-range"),I=document.getElementById("reports-cfd-include-done");if(z){const f=v(z);n.push(f);const x=()=>{const S=Number.parseInt((Y?.value??"90").toString(),10),C=Number.isFinite(S)?Math.min(365,Math.max(7,S)):90,U=I?I.checked===!0:!0,W=new Date,Z=T(W,-(C-1)),{labels:q,seriesDefs:K}=Le({tasks:a,columns:r,rangeStart:Z,rangeEnd:W,includeDone:U});f.setOption($e({labels:q,seriesDefs:K,boardName:o}),!0)};x(),Y?.addEventListener("change",x),I?.addEventListener("change",x)}window.addEventListener("resize",()=>{for(const f of n)f.resize()})}Me();
