import{q as P,m as j,r as H,f as U,n as q,l as G,a as Z}from"./theme-D6NMOEF9.js";import{u as _,i as v,a as J,b as K,c as Q,d as X,e as ee,f as te,g as ne,h as oe,j as re,k as ae,l as le}from"./vendor-echarts-uPYFcEXt.js";import"./vendor-pJTqpwCg.js";import"./vendor-zrender-uIsHjr8e.js";_([J,K,Q,X,ee,te,ne,oe,re,ae,le]);function w(n,o){return getComputedStyle(document.documentElement).getPropertyValue(n).trim()||o}function L(){return{text:w("--text","#111827"),muted:w("--text-muted","#6b7280"),border:w("--border","#d1d5db"),borderSubtle:w("--border-subtle","#e5e7eb"),surface:w("--surface","#ffffff")}}function se(n){const o=(n||"").toString().trim();return o&&o.length>=10?o.slice(0,10):""}function S(n){const o=n.getFullYear(),r=String(n.getMonth()+1).padStart(2,"0"),a=String(n.getDate()).padStart(2,"0");return`${o}-${r}-${a}`}function B(n,o){const r=[],a=new Date(n.getFullYear(),n.getMonth(),n.getDate()),i=new Date(o.getFullYear(),o.getMonth(),o.getDate());for(;a<=i;)r.push(new Date(a)),a.setDate(a.getDate()+1);return r}function D(n){const o=(n||"").toString().trim();if(!o)return null;const r=new Date(o);return Number.isNaN(r.getTime())?null:r}function N(n){const o=new Date(n.getFullYear(),n.getMonth(),n.getDate()),a=(o.getDay()+6)%7;return o.setDate(o.getDate()-a),o}function z(n,o){const r=new Date(n);return r.setDate(r.getDate()+o),r}function ie(n){const o=z(n,6);return`${S(n)}…${S(o)}`}function ce(n,o){const r=[],a=N(n),i=N(o),t=new Date(a);for(;t<=i;)r.push(new Date(t)),t.setDate(t.getDate()+7);return r}function de(n,o,r){const a=new Map;for(const s of n||[]){const l=se(s?.changeDate);l&&a.set(l,(a.get(l)||0)+1)}const t=B(o,r).map(s=>{const l=S(s);return[l,a.get(l)||0]}),e=t.reduce((s,[,l])=>Math.max(s,Number(l)||0),0);return{data:t,max:e}}function ue({rangeStart:n,rangeEnd:o,data:r,maxValue:a,boardName:i}){const t=Math.max(1,a||0),e=L();return{backgroundColor:"transparent",textStyle:{color:e.text},title:{top:20,left:"center",text:`Daily updates — ${i}`,textStyle:{color:e.text}},tooltip:{backgroundColor:e.surface,borderColor:e.border,textStyle:{color:e.text},formatter:s=>{const l=s?.value?.[0]||"",u=s?.value?.[1]??0;return`${l}: ${u} update${u===1?"":"s"}`}},visualMap:{min:0,max:t,type:"piecewise",orient:"horizontal",left:"center",top:55,textStyle:{color:e.muted}},calendar:{top:110,left:30,right:30,cellSize:["auto",14],range:[S(n),S(o)],itemStyle:{borderWidth:.5,borderColor:e.borderSubtle},dayLabel:{color:e.muted},monthLabel:{color:e.text},yearLabel:{show:!1}},series:{type:"heatmap",coordinateSystem:"calendar",data:r}}}function me(n,o){const r=Math.max(1,Number(o)||1),a=[];for(let i=0;i<n.length;i++){const t=Math.max(0,i-r+1),e=n.slice(t,i+1).filter(l=>Number.isFinite(l));if(e.length===0){a.push(null);continue}const s=e.reduce((l,u)=>l+u,0)/e.length;a.push(Number(s.toFixed(2)))}return a}function ye(n,o,r){const a=new Map;for(const d of n){const y=D(d?.creationDate),c=D(d?.doneDate);if(!y||!c||c<o||c>r)continue;const p=N(c),g=S(p),b=(c.getTime()-y.getTime())/(1440*60*1e3);if(!Number.isFinite(b)||b<0)continue;const x=a.get(g)||{count:0,leadSumDays:0};x.count+=1,x.leadSumDays+=b,a.set(g,x)}const i=ce(o,r),t=i.map(ie),e=i.map(d=>S(d)),s=e.map(d=>a.get(d)?.count||0),l=e.map(d=>{const y=a.get(d);return!y||y.count===0?null:Number((y.leadSumDays/y.count).toFixed(2))}),u=s.reduce((d,y)=>d+y,0),f=e.map(d=>{const y=a.get(d);return!y||y.count===0?null:y.leadSumDays/y.count}).filter(d=>Number.isFinite(d)),m=f.length?f.reduce((d,y)=>d+y,0)/f.length:null;return{labels:t,completedCounts:s,avgLeadDays:l,trendLeadDays:me(l.map(d=>d??NaN),4),totalCompleted:u,avgLeadOverall:m}}function pe({labels:n,avgLeadDays:o,trendLeadDays:r,completedCounts:a}){const i=Math.max(1,...o.map(e=>Number.isFinite(e)?e:0)),t=L();return{backgroundColor:"transparent",textStyle:{color:t.text},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},backgroundColor:t.surface,borderColor:t.border,textStyle:{color:t.text},formatter:e=>{const s=Array.isArray(e)?e:[],l=s[0]?.axisValueLabel||"",u=new Map(s.map(g=>[g.seriesName,g.value])),f=u.get("Avg lead time (days)"),m=u.get("Trend (4-week MA)"),d=u.get("Completed"),y=Number.isFinite(f)?`${f}d`:"—",c=Number.isFinite(m)?`${m}d`:"—",p=Number.isFinite(d)?`${d}`:"0";return`${l}<br/>Completed: ${p}<br/>Avg lead time: ${y}<br/>Trend: ${c}`}},legend:{top:8,textStyle:{color:t.muted}},grid:{left:40,right:40,top:50,bottom:40},xAxis:{type:"category",data:n,axisLabel:{interval:1,rotate:20,color:t.muted},axisLine:{lineStyle:{color:t.borderSubtle}},axisTick:{lineStyle:{color:t.borderSubtle}}},yAxis:[{type:"value",name:"Days",min:0,max:Math.ceil(i),nameTextStyle:{color:t.muted},axisLabel:{color:t.muted},axisLine:{lineStyle:{color:t.borderSubtle}},axisTick:{lineStyle:{color:t.borderSubtle}},splitLine:{lineStyle:{color:t.borderSubtle}}},{type:"value",name:"Completed",min:0,nameTextStyle:{color:t.muted},axisLabel:{formatter:"{value}",color:t.muted},axisLine:{lineStyle:{color:t.borderSubtle}},axisTick:{lineStyle:{color:t.borderSubtle}},splitLine:{show:!1}}],series:[{name:"Completed",type:"bar",data:a,itemStyle:{color:"#3b82f6"},yAxisIndex:1},{name:"Avg lead time (days)",type:"line",data:o.map(e=>e??null),smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:3,color:"#16a34a"},itemStyle:{color:"#16a34a"},yAxisIndex:0},{name:"Trend (4-week MA)",type:"line",data:r.map(e=>e??null),smooth:!0,symbol:"none",lineStyle:{width:2,type:"dashed",color:"#6b7280"},itemStyle:{color:"#6b7280"},yAxisIndex:0}]}}function ge({labels:n,completedCounts:o}){const r=L();return{backgroundColor:"transparent",grid:{left:8,right:8,top:8,bottom:8},xAxis:{type:"category",data:n,show:!1},yAxis:{type:"value",show:!1,min:0},tooltip:{trigger:"axis",axisPointer:{type:"line"},backgroundColor:r.surface,borderColor:r.border,textStyle:{color:r.text},formatter:a=>{const i=Array.isArray(a)?a[0]:a,t=i?.axisValueLabel||"",e=i?.value??0;return`${t}<br/>Completed: ${e}`}},series:[{type:"line",data:o,smooth:!0,symbol:"none",lineStyle:{width:2,color:"#3b82f6"},areaStyle:{color:"rgba(59, 130, 246, 0.18)"}}]}}function O(n){return typeof n=="string"&&/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(n.trim())}function fe(n,o){const r=Math.max(0,Math.min(1,Number(o)));if(!O(n))return`rgba(59,130,246,${r})`;const a=n.trim().slice(1),i=a.length===3?a.split("").map(l=>l+l).join(""):a,t=Number.parseInt(i.slice(0,2),16),e=Number.parseInt(i.slice(2,4),16),s=Number.parseInt(i.slice(4,6),16);return`rgba(${t},${e},${s},${r})`}function be(n){const o=Array.isArray(n)?n.slice():[],r=o.find(e=>e?.id==="done")||null,i=o.filter(e=>e?.id&&e.id!=="done").map((e,s)=>({c:e,idx:s}));i.sort((e,s)=>{const l=Number.isFinite(e.c?.order)?e.c.order:null,u=Number.isFinite(s.c?.order)?s.c.order:null;return l!=null&&u!=null&&l!==u?l-u:l!=null&&u==null?-1:l==null&&u!=null?1:e.idx-s.idx});const t=i.map(e=>e.c);return r&&t.push(r),t}function xe(n){const o=n?.columnHistory,a=(Array.isArray(o)?o:[]).map(e=>{const s=typeof e?.column=="string"?e.column.trim():"",l=D(e?.at);return!s||!l?null:{column:s,at:l}}).filter(Boolean).sort((e,s)=>e.at.getTime()-s.at.getTime());if(a.length>0)return a;const i=D(n?.creationDate)||D(n?.changeDate)||D(n?.doneDate),t=typeof n?.column=="string"?n.column.trim():"";return!i||!t?[]:[{column:t,at:i}]}function he({tasks:n,columns:o,rangeStart:r,rangeEnd:a,includeDone:i}){const t=B(r,a),e=t.map(c=>new Date(c.getFullYear(),c.getMonth(),c.getDate(),23,59,59,999)),s=t.map(c=>S(c)),l=new Map,u=c=>(l.has(c)||l.set(c,new Array(s.length).fill(0)),l.get(c));for(const c of n||[]){const p=xe(c);if(!p.length)continue;let g=null,b=-1;for(let x=0;x<e.length;x++){const C=e[x];for(;b+1<p.length&&p[b+1].at<=C;)b+=1,g=p[b].column;if(!g||!i&&g==="done")continue;const k=u(g);k[x]+=1}}const f=be(o),m=new Map(f.map(c=>[c.id,c])),d=f.map(c=>c.id);for(const c of l.keys())d.includes(c)||d.push(c);const y=d.filter(c=>i||c!=="done").map(c=>{const p=m.get(c),g=typeof p?.name=="string"&&p.name.trim()?p.name.trim():c==="done"?"Done":c,b=O(p?.color)?p.color.trim():"#3b82f6",x=l.get(c)||new Array(s.length).fill(0);return{id:c,name:g,color:b,data:x}});return{labels:s,seriesDefs:y}}function Se({labels:n,seriesDefs:o,boardName:r}){const a=Array.isArray(o)?o.slice().reverse():[],i=o.length?Math.max(1,...n.map((e,s)=>o.reduce((l,u)=>l+(u.data[s]||0),0))):1,t=L();return{backgroundColor:"transparent",textStyle:{color:t.text},title:{top:12,left:"center",text:`Cumulative flow — ${r}`,textStyle:{color:t.text}},tooltip:{trigger:"axis",axisPointer:{type:"line"},backgroundColor:t.surface,borderColor:t.border,textStyle:{color:t.text},formatter:e=>{const s=Array.isArray(e)?e:[],u=[`${s[0]?.axisValueLabel||""}`];let f=0;for(const m of s){const d=Number(m?.value)||0;f+=d,u.push(`${m.marker||""}${m.seriesName}: ${d}`)}return u.push(`<span style="opacity:.7">Total: ${f}</span>`),u.join("<br/>")}},legend:{top:40,type:"scroll",textStyle:{color:t.muted}},grid:{left:40,right:20,top:80,bottom:45},xAxis:{type:"category",data:n,boundaryGap:!1,axisLabel:{hideOverlap:!0,color:t.muted},axisLine:{lineStyle:{color:t.borderSubtle}},axisTick:{lineStyle:{color:t.borderSubtle}}},yAxis:{type:"value",name:"Tasks",min:0,max:Math.ceil(i),nameTextStyle:{color:t.muted},axisLabel:{color:t.muted},axisLine:{lineStyle:{color:t.borderSubtle}},axisTick:{lineStyle:{color:t.borderSubtle}},splitLine:{lineStyle:{color:t.borderSubtle}}},dataZoom:[{type:"inside",xAxisIndex:0,filterMode:"none"}],series:a.map(e=>({name:e.name,type:"line",stack:"total",symbol:"none",data:e.data,lineStyle:{width:1.5,color:e.color},itemStyle:{color:e.color},areaStyle:{color:fe(e.color,.28)},emphasis:{focus:"series"}}))}}function De(){P(),j(),H();const n=U();q();const o=document.getElementById("reports-board-badge");o&&(o.textContent=n.slice(0,2).toUpperCase());const r=G(),a=Z(),i=new Date,t=new Date;t.setDate(i.getDate()-364);const e=de(r,t,i),s=document.getElementById("reports-chart");if(s){const h=v(s);h.setOption(ue({rangeStart:t,rangeEnd:i,data:e.data,maxValue:e.max,boardName:n})),window.addEventListener("resize",()=>h.resize())}const l=new Date,u=new Date(l.getFullYear(),l.getMonth(),l.getDate(),23,59,59,999),f=z(u,-77),m=ye(r,f,u),d=m.completedCounts[m.completedCounts.length-1]||0,y=m.completedCounts[m.completedCounts.length-2]||0,c=Number.isFinite(m.avgLeadOverall)?`${m.avgLeadOverall.toFixed(1)}d`:"–",p=document.getElementById("reports-completed-this-week"),g=document.getElementById("reports-completed-last-week"),b=document.getElementById("reports-avg-leadtime-12w");p&&(p.textContent=String(d)),g&&(g.textContent=String(y)),b&&(b.textContent=c);const x=document.getElementById("reports-leadtime-badge");x&&(x.textContent=String(m.totalCompleted));const C=document.getElementById("reports-completed-spark");if(C){const h=v(C);h.setOption(ge({labels:m.labels,completedCounts:m.completedCounts})),window.addEventListener("resize",()=>h.resize())}const k=document.getElementById("reports-leadtime-chart");if(k){const h=v(k);h.setOption(pe({labels:m.labels,avgLeadDays:m.avgLeadDays,trendLeadDays:m.trendLeadDays,completedCounts:m.completedCounts})),window.addEventListener("resize",()=>h.resize())}const T=document.getElementById("reports-cfd-chart"),I=document.getElementById("reports-cfd-range"),$=document.getElementById("reports-cfd-include-done");if(T){const h=v(T),A=()=>{const M=Number.parseInt((I?.value??"90").toString(),10),W=Number.isFinite(M)?Math.min(365,Math.max(7,M)):90,Y=$?$.checked===!0:!0,E=new Date,F=new Date;F.setDate(E.getDate()-(W-1));const{labels:V,seriesDefs:R}=he({tasks:r,columns:a,rangeStart:F,rangeEnd:E,includeDone:Y});h.setOption(Se({labels:V,seriesDefs:R,boardName:n}),!0)};A(),I?.addEventListener("change",A),$?.addEventListener("change",A),window.addEventListener("resize",()=>h.resize())}}De();
